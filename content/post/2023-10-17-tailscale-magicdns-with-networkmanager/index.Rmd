---
title: TailscaleのMagicDNSがなぜかLinux上で動かなくなったのでトラブルシューティングした
author: ''
date: '2023-10-17'
slug: tailscale-magicdns-with-networkmanager
categories: [tailscale]
tags: []
output:
  blogdown::html_page:
    md_extensions: +east_asian_line_breaks+task_lists
---

MagicDNSを使っているつもりだが、名前解決に失敗する……！

どうやらLinuxの場合、NetworkManager + systemd-resolvedという構成を使っているケースが多いらしく、以下のようにして、 `/etc/resolv.conf`を設定してやればいいようだ（[Configuring Linux DNS](https://tailscale.com/kb/1188/linux-dns/)）。

``` bash
$ sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
```

公式にトラブルシューティングがあるのはありがたい。

シンボリックリンクを貼る前に`cat /etc/resolv.conf`すると`# Generated by NetworkManager`というコメントがあり、NetworkManagerが自動生成してしまうようです。

[`man 5 NetworkManager.conf`](https://developer-old.gnome.org/NetworkManager/stable/NetworkManager.conf.html)によると、どうも`rc-manager`の設定次第で`/etc/resolv.conf`が上書きされるか決まるようです。
既定値の`auto`の場合、上書きするかは状況次第で、たとえば`resolv.conf`が`/run/systemd/resolve/stub-resolv.conf`のシンボリックリンクになっていれば、上書きされない模様。

あとは関連するサービスにrestartをかけてやればいいようです。

``` bash
$ sudo systemctl restart systemd-resolved
$ sudo systemctl restart NetworkManager
$ sudo systemctl restart tailscaled
```

公式に従ってるだけであんまり中身のない記事ですが、自分への備忘録として……。

ENJOY!
