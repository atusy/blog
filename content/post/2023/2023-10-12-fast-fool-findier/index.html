---
title: Rã§ã‚¢ãƒ›ã«ãªã£ãŸè¦ç´ ã‚’é€Ÿãè¦‹ã¤ã‘ã‚ï¼ï¼ˆãƒŠãƒ™ã‚¢ãƒ„ãƒã‚¿ï¼‰
author: ''
date: '2023-10-12'
slug: fast-fool-findier
categories: [Tech]
tags: []
output:
  blogdown::html_page:
    md_extensions: +east_asian_line_breaks+task_lists
---



<blockquote>
<p>ãƒŠãƒ™ã‚¢ãƒ„ã¯æ•°å­—ãŒã§ã‹ããªã‚‹ã»ã©ã‚¢ãƒ›ã«ãªã‚‹å‰²åˆãŒã‚¢ãƒƒãƒ—ã™ã‚‹ã¨èã„ãŸã®ã§æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸ
<a href="https://twitter.com/jagarikin/status/1711855799184785732" class="uri">https://twitter.com/jagarikin/status/1711855799184785732</a></p>
</blockquote>
<p>ã“ã‚Œã‚’Rã§ã‚„ã£ã¦ã¿ã‚‹ã¹ãã€MITTIã•ã‚“ãŒæ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ãŒé‡ã„ã‚‰ã—ã„ã§ã™ã€‚</p>
<blockquote>
<pre class="r"><code>f &lt;- function(n){
x &lt;- 1:10^n
mean(str_detect(x, &quot;[3]&quot;) | x %% 3 == 0)
}</code></pre>
<p>f(8)ã§macãŒãƒ•ãƒªãƒ¼ã‚ºã—ã¦å›°ã£ãŸã“ã¨ã«ãªã£ã¦ã‚‹ğŸ˜‡</p>
<p><a href="https://twitter.com/MITTI12101/status/1712071347466305823" class="uri">https://twitter.com/MITTI12101/status/1712071347466305823</a></p>
</blockquote>
<p>ã¨ã„ã†ã‚ã‘ã§é«˜é€ŸåŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<div id="ã®å€æ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹" class="section level2">
<h2>3ã®å€æ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹</h2>
<p>ä¸€èˆ¬çš„ãªæ–¹æ³•ã¨ã—ã¦3ã®å€æ•°ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ã«ã¯3ã§å‰²ã£ãŸä½™ã‚ŠãŒ0ã§ã‚ã‚‹ã‹ç¢ºèªã™ã‚‹ã®ãŒè‰¯ã„ã§ã™ã€‚</p>
<p>ã—ã‹ã—ã€æ¡ãŒå¢—ãˆã‚‹ã¨è¨ˆç®—è² è·ãŒé«˜ããªã‚‹ã®ã‚‚å½“ç„¶ã§ã™ã€‚</p>
<p>ä»Šå›ã®å ´åˆã€<code>1:10^n</code>ã«å¯¾ã—ã¦ãã‚Œãã‚ŒãŒ3ã®å€æ•°ã‹åˆ¤å®šã—ã¦ã„ã‚‹ã¨ã“ã‚ã«æ³¨ç›®ã™ã‚‹ã¨ã€å‰°ä½™ã®è¨ˆç®—ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚</p>
<p>ã ã£ã¦3ã®å€æ•°ã¯3å›ã”ã¨ã«ç¾ã‚Œã‚‹ã®ã ã‚‚ã®ã€‚</p>
<pre class="r"><code>n &lt;- 7
bench::mark(
  occurrence = rep_len(c(FALSE, FALSE, TRUE), 10L^n),
  jouyo = seq(10L^n) %% 3L == 0L,
  min_iterations = 10
) |&gt; plot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/factor-of-three-1.png" width="672" /></p>
</div>
<div id="ã®ã¤ãæ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹" class="section level2">
<h2>3ã®ã¤ãæ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹</h2>
<p>å…ƒã®ä¾‹ã§ã¯ <code>str_detect(x, "[3]")</code> ã¨ã€æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ã¦æ¤œå‡ºã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€ä»Šå›ã¯æ­£è¦è¡¨ç¾ã¾ã§ä½¿ã†ç†ç”±ã¯è–„ã„ã§ã™ã­ã€‚</p>
<p><code>stringi::stri_detect_fixed()</code> ã‚„ <code>grepl(fixed = TRUE)</code> ã‚’ä½¿ã†ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚ãªãœã‹ã¯çŸ¥ã‚Šã¾ã›ã‚“ãŒã€éƒ¨åˆ†ä¸€è‡´ã§ã‚ã‚Œã°<code>grepl(fixed = TRUE)</code>ãŒæœ€é€Ÿã®ã‚ˆã†ã§ã™ã€‚
<strong>base</strong>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚ãªã©ã‚Œã¾ã›ã‚“ã­ã€‚</p>
<pre class="r"><code>x &lt;- seq(10^6)
bench::mark(
  stri_detect_fixed = stringi::stri_detect_fixed(x, &quot;3&quot;),
  str_detect = stringr::str_detect(x, &quot;3&quot;),
  grepl_fixed = grepl(&quot;3&quot;, x, fixed = TRUE),
  grepl = grepl(&quot;3&quot;, x),
  min_iterations = 10
) |&gt; plot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/str-detect-3-1.png" width="672" /></p>
<p>ã¨ã“ã‚ã§ã€ä»»æ„ã®æ•°å€¤ã«å¯¾ã—ã¦3ã‚’å«ã‚€ã‹æ¤œè¨¼ã™ã‚‹ã®ã§ã‚ã‚Œã°ä¸Šè¨˜ãŒä¸€èˆ¬è§£ã§ã—ã‚‡ã†ã€‚</p>
<p>3ã®å€æ•°ã®æ¤œå‡ºã§ã‚‚æŒ‡æ‘˜ã—ãŸé€šã‚Šã€ä»Šå›ã¯<code>1ï¼š10^n</code>ã¨ã„ã†æ•°åˆ—ã«å¯¾ã—ã¦3ã‚’å«ã‚€ã‹æ¤œå‡ºã—ãŸã„ã®ã§ã€3ãŒã©ã“ã«ç¾ã‚Œã‚‹ã‹è€ƒãˆã‚‹ã¨ã€ãšã£ã¨é€Ÿããªã‚Šã¾ã™ã€‚</p>
<p>ãŸã¨ãˆã°1ã®ä½ã«3ãŒå‡ºç¾ã™ã‚‹ã®ã¯3, 13, 23, â€¦ ã¨10å›èµ·ãã§ã™ã€‚
10ã®ä½ã«3ãŒå‡ºç¾ã™ã‚‹ã®ã¯30~39, 130~139, 230~239, â€¦ã¨100å›èµ·ãã«10å›ã§ã™ã€‚</p>
<p>ã“ã®æ€§è³ªã«æ³¨ç›®ã—ãŸ<code>has3_by_occurrence()</code>ã‚’ã€å…ˆã®<code>grepl(fixed = TRUE)</code>ã¨æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre class="r"><code>has3_internal &lt;- function(n) {
  x &lt;- rep_len(FALSE, 10L^n)
  k &lt;- 10L^(n - 1L)
  i &lt;- 3L * k
  x[i:(i + k - 1)] &lt;- TRUE
  x
}

has3_by_occurrence &lt;- function(n) {
  len &lt;- 10^n
  x &lt;- logical(len)
  for (i in seq(n)) {
    x[rep_len(has3_internal(i), len)] &lt;- TRUE
  }
  x
}

bench::mark(
  occurrence = has3_by_occurrence(7),
  grepl_fixed = grepl(&quot;3&quot;, seq(10^7), fixed = TRUE),
  min_iterations = 10,
) |&gt; plot()
#&gt; Warning: Some expressions had a GC in every iteration; so filtering is
#&gt; disabled.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/has-three-1.png" width="672" /></p>
<p>ã‚±ã‚¿ã§é€Ÿã„ã§ã™ã­ã€‚</p>
<p>ã¡ãªã¿ã«ã€<code>has3_by_occurrence()</code>ã§ã¯ã€<code>has3_internal()</code>ã®è¿”ã‚Šå€¤ã‚’<code>rep_len()</code>ã—ã¦é•·ã•èª¿æ•´ã—ã¦ã„ã¾ã—ãŸã€‚</p>
<p>å¯èª­æ€§ã‚’çŠ ç‰²ã«ã—ã¦ã„ã„ãªã‚‰ã°ã€RãŒãƒ™ã‚¯ãƒˆãƒ«ã‚’ãƒªã‚µã‚¤ã‚¯ãƒ«ã™ã‚‹ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€æ›´ã«é€Ÿããªã‚Šã¾ã™ã€‚</p>
<pre class="r"><code>has3_by_occurrence2 &lt;- function(n) {
  len &lt;- 10^n
  x &lt;- logical(len)
  for (i in seq(n)) {
    x[has3_internal(i)] &lt;- TRUE
  }
  x
}

bench::mark(
  occurrence1 = has3_by_occurrence(7),
  occurrence2 = has3_by_occurrence2(7),
  min_iterations = 10,
) |&gt; plot()
#&gt; Warning: Some expressions had a GC in every iteration; so filtering is
#&gt; disabled.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/has-three-2-1.png" width="672" /></p>
</div>
<div id="ã®å€æ•°ã¾ãŸã¯3ã®ã¤ãæ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹" class="section level2">
<h2>3ã®å€æ•°ã¾ãŸã¯3ã®ã¤ãæ•°ã‚’é€Ÿãè¦‹ã¤ã‘ã‚‹</h2>
<p>ä»¥ä¸Šã‚’è¸ã¾ãˆã¦ã€å…ƒã®ä¾‹ã‚’baselineã¨ã—ãŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre class="r"><code>aho_baseline &lt;- function(n) {
  x &lt;- 1:10^n
  stringr::str_detect(x, &quot;[3]&quot;) | x %% 3 == 0
}

aho_fast_internal &lt;- function(n) {
  x &lt;- rep_len(FALSE, 10L^n)
  k &lt;- 10L^(n - 1L)
  i &lt;- 3L * k
  x[i:(i + k - 1)] &lt;- TRUE
  x
}

aho_fast &lt;- function(n) {
  len &lt;- 10L^n

  # 3ã®å€æ•°ãªã‚‰TRUE
  x &lt;- rep_len(c(FALSE, FALSE, TRUE), len) # 3ã®å€æ•°ã§ãƒã‚«ã«ãªã‚‹

  # 3ãŒã¤ããªã‚‰TRUE
  for (m in seq(n)) {
    x[aho_fast_internal(m)] &lt;- TRUE # 3ãŒã¤ãã¨ãƒã‚«ã«ãªã‚‹
  }

  x
}

bench::mark(
  baseline = aho_baseline(6),
  fast = aho_fast(6),
  min_iterations = 10,
) |&gt; plot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/aho6-1.png" width="672" /></p>
<p>ååˆ†ã«é«˜é€ŸåŒ–ã—ã¦ã„ã¾ã™ã­ã€‚ã¡ã‚‡ã£ã¨æ„å¤–ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã“ã§ã¯ <code>for</code> ãŒé«˜é€ŸåŒ–ã§å¤§æ´»èºã—ã¦ã„ã¾ã™ã€‚</p>
<p>MITTIã•ã‚“ã¨ã¯ç’°å¢ƒãŒç•°ãªã‚‹ã‚‚ã®ã®ã€8ã‚±ã‚¿ã§ã‚‚ååˆ†ã«æˆ¦ãˆã¾ã™ã€‚</p>
<pre class="r"><code>plot(bench::mark(aho_fast(8), min_iterations = 10))
#&gt; Warning: Some expressions had a GC in every iteration; so filtering is
#&gt; disabled.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/aho8-1.png" width="672" /></p>
</div>
<div id="ã‚¢ãƒ›ã«ãªã‚‹å‰²åˆ" class="section level2">
<h2>ã‚¢ãƒ›ã«ãªã‚‹å‰²åˆ</h2>
<p>ã›ã£ã‹ããªã®ã§è¦‹ã¦ãŠãã¾ã—ã‚‡ã†ã€‚</p>
<pre class="r"><code>seq(8) |&gt;
  purrr::map_dbl(function(n) mean(aho_fast(n))) |&gt;
  print() |&gt;
  plot()
#&gt; [1] 0.3000000 0.4500000 0.5130000 0.5625000 0.6063300 0.6457050 0.6811353
#&gt; [8] 0.7130218</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/plot-1.png" width="672" /></p>
<p>ã‚ã¾ã‚ŠçŸ¥ã‚‰ã‚Œã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Rã«ãŠã„ã¦ã€<code>print</code>é–¢æ•°ã¯å…¥åŠ›ã‚’ãã®ã¾ã¾è¿”ã™ã®ãŒãŠä½œæ³•ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ãªã®ã§ãƒ‘ã‚¤ãƒ—ã®é–“ã«æŒŸã‚“ã§ã‚‚ã¡ã‚ƒã‚“ã¨æ©Ÿèƒ½ã—ã¾ã™ã€‚</p>
<p>ã„ã‚„ã‚ã€ã“ã†ã„ã†Rã‚‰ã—ã•ã‚’ä½¿ã£ãŸé«˜é€ŸåŒ–ã€æ¥½ã—ã„ã§ã™ã­ï¼</p>
<p>ENJOY!</p>
</div>
