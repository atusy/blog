---
title: TailscaleのMagicDNSがなぜかLinux上で動かなくなったのでトラブルシューティングした
author: ''
date: '2023-10-17'
slug: tailscale-magicdns-with-networkmanager
categories: [tailscale]
tags: []
output:
  blogdown::html_page:
    md_extensions: +east_asian_line_breaks+task_lists
---



<p>MagicDNSを使っているつもりだが、名前解決に失敗する……！</p>
<p>どうやらLinuxの場合、NetworkManager + systemd-resolvedという構成を使っているケースが多いらしく、以下のようにして、 <code>/etc/resolv.conf</code>を設定してやればいいようだ（<a href="https://tailscale.com/kb/1188/linux-dns/">Configuring Linux DNS</a>）。</p>
<pre class="bash"><code>$ sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf</code></pre>
<p>公式にトラブルシューティングがあるのはありがたい。</p>
<p>シンボリックリンクを貼る前に<code>cat /etc/resolv.conf</code>すると<code># Generated by NetworkManager</code>というコメントがあり、NetworkManagerが自動生成してしまうようです。</p>
<p><a href="https://developer-old.gnome.org/NetworkManager/stable/NetworkManager.conf.html"><code>man 5 NetworkManager.conf</code></a>によると、どうも<code>rc-manager</code>の設定次第で<code>/etc/resolv.conf</code>が上書きされるか決まるようです。既定値の<code>auto</code>の場合、上書きするかは状況次第で、たとえば<code>resolv.conf</code>が<code>/run/systemd/resolve/stub-resolv.conf</code>のシンボリックリンクになっていれば、上書きされない模様。</p>
<p>あとは関連するサービスにrestartをかけてやればいいようです。</p>
<pre class="bash"><code>$ sudo systemctl restart systemd-resolved
$ sudo systemctl restart NetworkManager
$ sudo systemctl restart tailscaled</code></pre>
<p>公式に従ってるだけであんまり中身のない記事ですが、自分への備忘録として……。</p>
<p>ENJOY!</p>
