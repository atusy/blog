---
title: "Vimのマッピングを拡張するサブモードに開始処理・終了処理を加える"
author: atusy
date: '2025-10-20'
slug: hooks-on-submode-in-vim
categories: [Tech]
tags: [Neovim, Vim, Vim駅伝]
output:
  blogdown::html_page:
    md_extensions: +east_asian_line_breaks+task_lists
highlighhtjs: [Lua]
summary: |
    サブモードを使うと`gjgjgkgjgj`のような繰り返しを`gjjkjj`のように簡略化する、`H`単発で画面上端に移動し連打で`<PageUp>`する、`j`連打で移動を加速するなど、さまざまな応用が可能です。
    更にマッピングの工夫で開始処理・終了処理も実現できるので紹介します。
---



<p>Vimはノーマルモードやインサートモードなどモードに応じてキーの機能が変わるエディタです。実はマッピングを工夫することで同一モード内で一時的に機能を変更するサブモード（通称）も実現できます。</p>
<p>たとえば、折り返しを考慮してカーソルを上下に移動する<code>gj</code>や<code>gk</code>の繰り返しを楽にするサブモードは以下のように簡単に定義できます。通常なら下下上下下と移動するのに<code>gjgjgkgjgj</code>と入力すべきところ、<code>gjjkjj</code>といった具合に<code>g</code>の入力を省略可能にするサブモードですね。</p>
<pre class="vim"><code>&quot; 通常のgj, gkのあとにplugマッピングでサブモードに入る
&quot; 実際にはplugマッピングをprefixにした入力待ち状態にすぎない
nnoremap gj gj&lt;plug&gt;(submode-gjk)
nnoremap gk gk&lt;plug&gt;(submode-gjk)

&quot; サブモード内でのj,kの挙動を定義
nnoremap &lt;plug&gt;(submode-gjk)j gj&lt;plug&gt;(submode-gjk)
nnoremap &lt;plug&gt;(submode-gjk)k gk&lt;plug&gt;(submode-gjk)

&quot; サブモード終了時はなにもしない
nnoremap &lt;plug&gt;(submode-gjk) &lt;nop&gt;</code></pre>
<p>このサブモードで<code>jk</code>以外を入力すると親モードの挙動に従うので、<code>gjjl</code>とすれば、2行下の1文字右に移動できます。</p>
<p>同様に<code>gtttTtT</code>のようにしてタブページを移動しても便利ですし、他にも様々な応用があります。</p>
<ul>
<li>H/LとPageUp/PageDownを共存させる設定 (submode編) <a href="https://blog.atusy.net/2024/05/29/vim-hl-enhanced/" class="uri">https://blog.atusy.net/2024/05/29/vim-hl-enhanced/</a></li>
<li>Vimのj/kを加速させるサブモード <a href="https://blog.atusy.net/2024/06/12/vim-submode-jjjj/" class="uri">https://blog.atusy.net/2024/06/12/vim-submode-jjjj/</a></li>
</ul>
<p>ところでサブモードの終了処理の実装方法について<a href="https://vim-jp.org/docs/chat.html">vim-jp slack</a>で質問がありました。</p>
<p>そこで、本記事ではサブモードの開始処理・終了処理をマッピングで実現する方法を紹介します。</p>
<div id="サブモード開始処理" class="section level1">
<h1>サブモード開始処理</h1>
<p>開始処理は素朴には<code>gj</code>や<code>gk</code>のマッピング内で実現できます。</p>
<pre class="vim"><code>nnoremap gj gj&lt;cmd&gt;echo &#39;Enter submode&#39;&lt;cr&gt;&lt;plug&gt;(submode-gjk-enter)
nnoremap gk gk&lt;cmd&gt;echo &#39;Enter submode&#39;&lt;cr&gt;&lt;plug&gt;(submode-gjk-enter)</code></pre>
<p>コード重複を避けるには、サブモード開始を別のplugマッピングに分けるとよいでしょう。サブモードで大量のマッピングを定義する場合、開始処理を一括で変更できるので便利です。</p>
<pre class="vim"><code>nnoremap gj gj&lt;plug&gt;(submode-gjk-enter)
nnoremap gk gk&lt;plug&gt;(submode-gjk-enter)
nnoremap &lt;plug&gt;(submode-gjk-enter) &lt;cmd&gt;echo &quot;Enter submode&quot;&lt;cr&gt;&lt;plug&gt;(submode-gjk)</code></pre>
</div>
<div id="サブモード終了処理" class="section level1">
<h1>サブモード終了処理</h1>
<p>終了処理を素朴に実装するなら<code>&lt;plug&gt;(submode-gjk)</code>に<code>&lt;nop&gt;</code>以外を割り当てます。これでサブモード待機時間の終了やサブモード対象外キーの入力による終了処理を定義できます。</p>
<pre class="vim"><code>nnoremap &lt;plug&gt;(submode-gjk) &lt;cmd&gt;echo &quot;Leave submode&quot;&lt;cr&gt;</code></pre>
<p>終了処理は別のplugマッピングに分けて定義してもよいでしょう。
<code>gj</code>、<code>gk</code>くらいなら関係ないかもしれませんが、特定条件で即座にサブモードを終了したい場合に便利です。たとえば、<code>gj&lt;esc&gt;</code>したらサブモードを即座に終了することもできます。マッピングなしに<code>gj&lt;esc&gt;</code>してもサブモードは終了しますが、<code>&lt;esc&gt;</code>はサブモードを終了してから親モードで実行されるため、意図しない挙動になる可能性があります。</p>
<pre class="vim"><code>nnoremap &lt;plug&gt;(submode-gjk) &lt;plug&gt;(submode-gjk-leave)
nnoremap &lt;plug&gt;(submode-gjk-leave) &lt;cmd&gt;echo &quot;Leave submode&quot;&lt;cr&gt;

&quot; サブモード中に`x`を押したら何もせずに終了
nnoremap &lt;plug&gt;(submode-gjk)&lt;esc&gt; &lt;plug&gt;(submode-gjk-leave)</code></pre>
</div>
<div id="まとめ" class="section level1">
<h1>まとめ</h1>
<p>以上をまとめると以下のようになります。みなさんもオレオレサブモードを作ってみてください！</p>
<pre class="vim"><code>&quot; サブモードを開始するマッピングの定義
nnoremap gj gj&lt;plug&gt;(submode-gjk-enter)
nnoremap gk gk&lt;plug&gt;(submode-gjk-enter)

&quot; サブモード開始処理
nnoremap &lt;plug&gt;(submode-gjk-enter) &lt;cmd&gt;echo &quot;Enter submode&quot;&lt;cr&gt;&lt;plug&gt;(submode-gjk)

&quot; サブモード終了処理
nnoremap &lt;plug&gt;(submode-gjk) &lt;plug&gt;(submode-gjk-leave)
nnoremap &lt;plug&gt;(submode-gjk-leave) &lt;cmd&gt;echo &quot;Leave submode&quot;&lt;cr&gt;

&quot; サブモード内でのj,kの挙動を定義
nnoremap &lt;plug&gt;(submode-gjk)j gj&lt;plug&gt;(submode-gjk)
nnoremap &lt;plug&gt;(submode-gjk)k gk&lt;plug&gt;(submode-gjk)</code></pre>
</div>
<div id="enjoy" class="section level1">
<h1>ENJOY!</h1>
<p><a href="https://vim-jp.org/ekiden/">Vim駅伝</a>2025-10-10の記事でした。</p>
<p>前回2025-10-17の記事はkawarimidollさんによる「<a href="https://zenn.dev/vim_jp/articles/fad47dfb5fcd09">Neovimのファイルタイプ検出は自分で微調整できるよ</a>」でした。</p>
<p><code>vim.filetype.add()</code>による微調整って便利ですよね。記事内でも言及頂いてますが、私も多用しています。</p>
<ul>
<li>Neovimでファイルタイプ判定にShebangを使う <a href="https://blog.atusy.net/2025/04/15/nvim-filetype-matching-with-shebang/" class="uri">https://blog.atusy.net/2025/04/15/nvim-filetype-matching-with-shebang/</a></li>
<li>chezmoiを使って管理しているdotfileのファイルタイプをNeovimにうまく認識させる <a href="https://blog.atusy.net/2023/01/11/neovim-filetype-matching-with-chezmoi/" class="uri">https://blog.atusy.net/2023/01/11/neovim-filetype-matching-with-chezmoi/</a></li>
</ul>
<p>次回2025-10-22の記事はkamechaさんによる「縦のカーソル移動を怠惰にやろう」だそうです。これまた先日もvim-jp slackで話題になったところ……！</p>
<p>お楽しみに！</p>
</div>
